<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MIP Evidence Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .upload-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .file-input-label:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-process {
            background: linear-gradient(45deg, #42e695, #3bb2b8);
            color: white;
        }

        .btn-download {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .content {
            padding: 30px;
        }

        .report-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 25px;
            color: #4a5568;
            border-left: 5px solid #4facfe;
            padding-left: 20px;
            font-weight: 600;
            margin-top: 30px;
        }

        .grid {
            display: grid;
            gap: 20px;
            margin-bottom: 25px;
        }

        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

        .card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .big-number {
            font-size: 2.2em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .metric-label {
            font-size: 0.9em;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }

        .chart-title {
            font-size: 1.3em;
            color: #4a5568;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .pie-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .pie-chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:nth-child(even) {
            background: #f8fafc;
        }

        tr:hover {
            background: #edf2f7;
            transition: background 0.3s ease;
        }

        .top-blocks, .bottom-blocks {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }

        .blocks-title {
            font-size: 1.4em;
            color: #4a5568;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .block-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .block-item:last-child {
            border-bottom: none;
        }

        .block-name {
            font-weight: 600;
            color: #2d3748;
        }

        .block-stats {
            display: flex;
            gap: 20px;
            color: #718096;
            font-size: 0.9em;
        }

        .percentage-badge {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        canvas {
            max-height: 400px;
        }

        #biharMap {
            width: 100%;
            height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #biharMap svg {
            max-width: 100%;
            max-height: 100%;
        }

        .district-path {
            stroke: #ffffff;
            stroke-width: 1;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .district-path:hover {
            stroke: #333;
            stroke-width: 2;
            filter: brightness(0.9);
        }

        .district-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        /* PDF-specific styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }

            .container {
                background: white !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }

            .header {
                background: #4facfe !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .section {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            .chart-container, table, .top-blocks, .bottom-blocks {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            .grid {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            /* Ensure content doesn't get cut across a page break */
            .section {
                break-inside: avoid;
                /* For older browsers */
                page-break-inside: avoid;
            }

            /* Force a page break *after* every major section */
            .section-to-break {
                page-break-after: always;
            }

            /* Hide non-report content only when printing/downloading */
            @media print {
                /* Hide headers, footers, sidebars, or buttons that shouldn't be in the PDF */
                .dashboard-header, .download-button {
                    display: none !important;
                }
            }
            /* 1. Ensure the entire report has padding (A4 borders) */
            #report {
                padding: 20px; /* Provides a clear border within the PDF page */
                background-color: #fff; /* Ensure background is white for clean pages */
            }

            /* 2. Target the main sections for separation */
            .report-section {
                /* Set padding/margin here to push content apart */
                margin-top: 30px !important; 
                margin-bottom: 30px !important;
                padding: 15px; /* Optional: adds space inside the section card */
            
                /* Critical for preventing content from being split across PDF pages */
                break-inside: avoid;
                page-break-inside: avoid;
            }

            /* 3. Force page break AFTER sections that should start a new page */
            /* This is much more reliable than the JS 'pagebreak' option */
            .section-to-break {
                page-break-after: always;
            }

            /* 4. Tidy up the very first element's margin */
            .report-section:first-child {
                margin-top: 0;
            }

            /* Optional: Hide header/footer/buttons when printing */
            @media print {
                .dashboard-header, .download-button {
                    display: none !important;
                }
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>MIP Evidence Analysis Dashboard</h1>
        <div class="upload-section">
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv">
                <label for="csvFile" class="file-input-label">üìÅ Choose CSV File</label>
            </div>
            <div class="file-input-wrapper">
                <input type="file" id="geojsonFile" accept=".geojson,.json">
                <label for="geojsonFile" class="file-input-label">üó∫Ô∏è Choose GeoJSON File (Optional)</label>
            </div>
            <button class="btn-process" onclick="processCSV()">üîÑ Process Data</button>
            <button class="btn-download" onclick="downloadPDF()">üìÑ Download PDF</button>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing your data...</p>
    </div>

    <div class="content">
        <div id="report" class="hidden"> 

            <div class="report-section section-to-break">
                <h2 class="section-title">üìä Executive Summary</h2>
                <div class="grid grid-3" id="execSummary">
                    </div>
            </div>

            <div class="report-section section-to-break">
                <h2 class="section-title">üìà Evidence Submission Overview</h2>
                <div class="grid grid-4" id="evidenceOverview">
                    </div>

                <div class="chart-container">
                    <div class="chart-title">Project Timeline</div>
                    <canvas id="monthlyLine"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Submission Volume</div>
                    <canvas id="submissionVolumeLine"></canvas>
                </div>

                <div class="pie-charts">
                    <div class="pie-chart-container">
                        <div class="chart-title">Subject Distribution</div>
                        <canvas id="subjectPie"></canvas>
                    </div>
                    <div class="pie-chart-container">
                        <div class="chart-title">Grade Distribution</div>
                        <canvas id="gradePie"></canvas>
                    </div>
                </div>
            </div>

            <div class="report-section section-to-break">
                <h2 class="section-title">üéØ Quality & Relevance Analysis</h2>
                <div class="table-responsive" id="relevanceTable"></div>
                <div class="table-responsive" id="relBySubjectGrade"></div>
                
                <div class="chart-container">
                    <div class="chart-title">Task Completion Analysis</div>
                    <canvas id="taskCompletionBar"></canvas>
                </div>
            </div>

            <div class="report-section"> 
                <h2 class="section-title">üó∫Ô∏è District-wise Submission Quality & Insights</h2>
                <div class="table-responsive" id="districtTable"></div>
                
                <div class="chart-container">
                    <div class="chart-title">Bihar District Relevance Map</div>
                    <div id="biharMap" style="min-height: 400px; display: flex; justify-content: center; align-items: center; background-color: #eef; border-radius: 8px;">
                        <span class="text-gray-500">Map placeholder area (Ensure map is static before PDF generation)</span>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; font-size: 14px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background: #42e695; border-radius: 4px;"></div>
                            <span>‚â•60% Relevant</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background: #feca57; border-radius: 4px;"></div>
                            <span>40-60% Relevant</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background: #ff6b6b; border-radius: 4px;"></div>
                            <span>&lt;40% Relevant</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background: #e0e0e0; border-radius: 4px;"></div>
                            <span>No Data</span>
                        </div>
                    </div>
                </div>
                
                <div id="topBottomBlocks" class="grid grid-2 mt-8">
                    </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. YOUR OPTIMIZED REPORTING LOGIC (UNCHANGED) ---

    function getTimelineSettings(minDate, maxDate) {
        if (!minDate || !maxDate) { return { unit: 'month' }; }
        const diffTime = Math.abs(maxDate.getTime() - minDate.getTime());
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (minDate.getMonth() === maxDate.getMonth() && minDate.getFullYear() === maxDate.getFullYear()) {
            return { unit: 'day' };
        }
        if (diffDays <= 183) { return { unit: 'week' }; }
        return { unit: 'month' };
    }

    function getGroupKey(dateStr, unit) {
        if (!dateStr) return null;
        const d = new Date(dateStr); 
        if (isNaN(d.getTime())) return null;
        try {
            if (unit === 'day') { return d.toISOString().split('T')[0]; }
            if (unit === 'month') { return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; }
            if (unit === 'week') {
                const dayOfWeek = d.getDay();
                const startOfWeek = new Date(d.setDate(d.getDate() - dayOfWeek));
                return startOfWeek.toISOString().split('T')[0];
            }
        } catch (e) { console.error("Error formatting date key:", dateStr, e); return null; }
        return null;
    }

    function parseSubject(task) {
        if (!task) return "Other";
        if (task.includes("‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®")) return "Science";
        if (task.includes("‡§ó‡§£‡§ø‡§§")) return "Math";
        if (task.includes("‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä") || task.includes("English")) return "English";
        return "Other";
    }

    function parseGrade(task) {
        const match = task.match(/‡§ï‡§ï‡•ç‡§∑‡§æ\s*(\d{1,2})/);
        return match ? "Grade " + match[1] : "Unknown";
    }

    function monthYear(dateStr) {
        if (!dateStr) return null;
        let d = new Date(dateStr);
        if (isNaN(d)) return null;
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }

    function processCSV() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) { alert("Please upload a CSV file."); return; }
        document.getElementById('loading').style.display = 'block';
        document.getElementById('report').classList.add('hidden');
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data;
                setTimeout(() => {
                    generateReport(data);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('report').classList.remove('hidden');
                }, 1000);
            }
        });
    }

    function generateReport(data) {
        const totalEvidence = data.length;
        const relevanceCounts = { Relevant:0, "Partially Relevant":0, Irrelevant:0 };
        const userSet = new Set();
        const schoolSet = new Set();
        const districtSet = new Set();
        const blockSet = new Set();
        const subjects = {};
        const grades = {};
        const projEvidences = {};
        const taskCounts = {};
        const districtStats = {};
        const blockStats = {};
        let minDate = new Date('2100-01-01');
        let maxDate = new Date('1970-01-01');
        const timelines = {
            day: { starts: {}, completions: {}, submissions: {}, relevant: {} },
            week: { starts: {}, completions: {}, submissions: {}, relevant: {} },
            month: { starts: {}, completions: {}, submissions: {}, relevant: {} }
        };
        data.forEach(row => {
            const rel = row["Relevance Tag"]?.trim();
            if (rel && relevanceCounts.hasOwnProperty(rel)) relevanceCounts[rel]++;
            userSet.add(row["UUID"]);
            schoolSet.add(row["School Name"]);
            districtSet.add(row["District"]);
            blockSet.add(row["Block"]);
            const subj = parseSubject(row["Tasks"]);
            subjects[subj] = (subjects[subj]||0) + 1;
            const grade = parseGrade(row["Tasks"]);
            grades[grade] = (grades[grade]||0) + 1;
            const projId = row["Project ID"];
            projEvidences[projId] = (projEvidences[projId]||0) + 1;
            const task = row["Tasks"];
            taskCounts[task] = (taskCounts[task]||0)+1;
            const startDate = new Date(row["Project start date of the user"]);
            const compDate = new Date(row["Project completion date of the user"]);
            const isRelevant = rel === "Relevant";
            if (!isNaN(startDate.getTime())) {
                if (startDate < minDate) minDate = new Date(startDate);
                if (startDate > maxDate) maxDate = new Date(startDate);
                const dayKey = getGroupKey(startDate, 'day');
                const weekKey = getGroupKey(startDate, 'week');
                const monthKey = getGroupKey(startDate, 'month');
                if(dayKey) timelines.day.starts[dayKey] = (timelines.day.starts[dayKey] || 0) + 1;
                if(weekKey) timelines.week.starts[weekKey] = (timelines.week.starts[weekKey] || 0) + 1;
                if(monthKey) timelines.month.starts[monthKey] = (timelines.month.starts[monthKey] || 0) + 1;
            }
            if (!isNaN(compDate.getTime())) {
                if (compDate < minDate) minDate = new Date(compDate);
                if (compDate > maxDate) maxDate = new Date(compDate);
                const dayKey = getGroupKey(compDate, 'day');
                const weekKey = getGroupKey(compDate, 'week');
                const monthKey = getGroupKey(compDate, 'month');
                if(dayKey) timelines.day.completions[dayKey] = (timelines.day.completions[dayKey] || 0) + 1;
                if(weekKey) timelines.week.completions[weekKey] = (timelines.week.completions[weekKey] || 0) + 1;
                if(monthKey) timelines.month.completions[monthKey] = (timelines.month.completions[monthKey] || 0) + 1;
                if(dayKey) timelines.day.submissions[dayKey] = (timelines.day.submissions[dayKey] || 0) + 1;
                if(weekKey) timelines.week.submissions[weekKey] = (timelines.week.submissions[weekKey] || 0) + 1;
                if(monthKey) timelines.month.submissions[monthKey] = (timelines.month.submissions[monthKey] || 0) + 1;
                if (isRelevant) {
                    if(dayKey) timelines.day.relevant[dayKey] = (timelines.day.relevant[dayKey] || 0) + 1;
                    if(weekKey) timelines.week.relevant[weekKey] = (timelines.week.relevant[weekKey] || 0) + 1;
                    if(monthKey) timelines.month.relevant[monthKey] = (timelines.month.relevant[monthKey] || 0) + 1;
                }
            }
            const dist = row["District"] || "Unknown";
            const blk = row["Block"] || "Unknown";
            const school = row["School Name"] || "Unknown";
            if (!districtStats[dist]) { districtStats[dist] = { total:0, Relevant:0, "Partially Relevant":0, Irrelevant:0, blocks: new Set(), schools: new Set() }; }
            districtStats[dist].total++;
            districtStats[dist].blocks.add(blk);
            districtStats[dist].schools.add(school);
            if (rel && districtStats[dist][rel] !== undefined) districtStats[dist][rel]++;
            const keyBlk = blk;
            if (!blockStats[keyBlk]) { blockStats[keyBlk] = { total:0, Relevant:0, schools: new Set() }; }
            blockStats[keyBlk].total++;
            blockStats[keyBlk].schools.add(school);
            if (rel === "Relevant") blockStats[keyBlk].Relevant++;
        });
        if (minDate > maxDate) { minDate = null; maxDate = null; }
        const timelineSettings = getTimelineSettings(minDate, maxDate);
        const { starts: monthlyStart, completions: monthlyCompletion, submissions: submissionVolume, relevant: relevantVolume } = timelines[timelineSettings.unit];
        const avgEvidPerSchool = (totalEvidence / schoolSet.size).toFixed(2);
        const avgEvidPerMIP = (Object.values(projEvidences).reduce((a,b)=>a+b,0) / Object.keys(projEvidences).length).toFixed(2);
        document.getElementById('execSummary').innerHTML = `<div class="card"><div class="metric-label">Total Evidence</div><div class="big-number">${totalEvidence.toLocaleString()}</div></div><div class="card"><div class="metric-label">Relevance Distribution</div><div style="font-size: 1.2em; line-height: 1.5;"><div><strong>${((relevanceCounts.Relevant/totalEvidence)*100).toFixed(1)}%</strong> Relevant</div><div><strong>${((relevanceCounts["Partially Relevant"]/totalEvidence)*100).toFixed(1)}%</strong> Partially</div><div><strong>${((relevanceCounts.Irrelevant/totalEvidence)*100).toFixed(1)}%</strong> Irrelevant</div></div></div><div class="card"><div class="metric-label">Participation</div><div class="big-number">${userSet.size}</div><div style="color: #718096;">Users with MIPs</div></div>`;
        document.getElementById('evidenceOverview').innerHTML = `<div class="card"><div class="metric-label">Schools</div><div class="big-number">${schoolSet.size}</div></div><div class="card"><div class="metric-label">Districts</div><div class="big-number">${districtSet.size}</div></div><div class="card"><div class="metric-label">Blocks</div><div class="big-number">${blockSet.size}</div></div><div class="card"><div class="metric-label">Avg per School</div><div class="big-number">${avgEvidPerSchool}</div></div>`;
        const labels = Array.from(new Set([...Object.keys(monthlyStart), ...Object.keys(monthlyCompletion)])).sort();
        if(window.projectTimelineChart) window.projectTimelineChart.destroy();
        window.projectTimelineChart = new Chart(document.getElementById('monthlyLine'), { type: 'line', data: { labels, datasets: [ { label: 'Project Starts', data: labels.map(l=>monthlyStart[l]||0), borderColor: '#4facfe', backgroundColor: 'rgba(79, 172, 254, 0.1)', fill: true, tension: 0.4 }, { label: 'Project Completions', data: labels.map(l=>monthlyCompletion[l]||0), borderColor: '#42e695', backgroundColor: 'rgba(66, 230, 149, 0.1)', fill: true, tension: 0.4 } ]}, options: { animation: false, responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)' } }, x: { grid: { color: 'rgba(0,0,0,0.1)' } } } } });
        const subLabels = Array.from(new Set([...Object.keys(submissionVolume), ...Object.keys(relevantVolume)])).sort();
        if(window.submissionVolumeChart) window.submissionVolumeChart.destroy();
        window.submissionVolumeChart = new Chart(document.getElementById('submissionVolumeLine'), { type: 'line', data: { labels: subLabels, datasets: [ { label: 'Total Evidence', data: subLabels.map(l => submissionVolume[l] || 0), borderColor: '#4facfe', backgroundColor: 'rgba(79, 172, 254, 0.1)', fill: true, tension: 0.4 }, { label: 'Relevant Evidence', data: subLabels.map(l => relevantVolume[l] || 0), borderColor: '#42e695', backgroundColor: 'rgba(66, 230, 149, 0.1)', fill: true, tension: 0.4 } ]}, options: { animation: false, responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)' } }, x: { grid: { color: 'rgba(0,0,0,0.1)' } } } } });
        if(window.subjectPieChart) window.subjectPieChart.destroy();
        window.subjectPieChart = new Chart(document.getElementById('subjectPie'), { type: 'doughnut', data: { labels: Object.keys(subjects), datasets: [{ data: Object.values(subjects), backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'], borderWidth: 0 }] }, options: { animation: false, responsive: true, cutout: '60%', plugins: { legend: { position: 'bottom' } } } });
        if(window.gradePieChart) window.gradePieChart.destroy();
        window.gradePieChart = new Chart(document.getElementById('gradePie'), { type: 'doughnut', data: { labels: Object.keys(grades), datasets: [{ data: Object.values(grades), backgroundColor: ['#a8e6cf', '#dcedc1', '#ffd3a5', '#fd9853', '#ff8a80'], borderWidth: 0 }] }, options: { animation: false, responsive: true, cutout: '60%', plugins: { legend: { position: 'bottom' } } } });
        document.getElementById('relevanceTable').innerHTML = `<table><thead><tr><th>Relevant</th><th>Partially Relevant</th><th>Irrelevant</th><th>Total</th></tr></thead><tbody><tr><td>${relevanceCounts.Relevant.toLocaleString()}</td><td>${relevanceCounts["Partially Relevant"].toLocaleString()}</td><td>${relevanceCounts.Irrelevant.toLocaleString()}</td><td>${totalEvidence.toLocaleString()}</td></tr></tbody></table>`;
        let relSG = {};
        data.forEach(row=>{ const subj = parseSubject(row["Tasks"]); const grade = parseGrade(row["Tasks"]); const key = subj+"_"+grade; if (!relSG[key]) relSG[key] = { Relevant:0, "Partially Relevant":0, Irrelevant:0, total:0 }; relSG[key].total++; const rel = row["Relevance Tag"]; if (rel && relSG[key][rel] !== undefined) relSG[key][rel]++; });
        let relSGHtml = `<table><thead><tr><th>Subject</th><th>Grade</th><th>Relevant</th><th>Partially Relevant</th><th>Irrelevant</th><th>Total</th><th>% Relevant</th></tr></thead><tbody>`;
        const sortedSG = Object.keys(relSG).sort();
        for (const k of sortedSG) { const [s,g] = k.split("_"); const r = relSG[k]; const relevantPercent = ((r.Relevant/r.total)*100).toFixed(1); relSGHtml += `<tr><td>${s}</td><td>${g}</td><td>${r.Relevant}</td><td>${r["Partially Relevant"]}</td><td>${r.Irrelevant}</td><td>${r.total}</td><td><span class="percentage-badge">${relevantPercent}%</span></td></tr>`; }
        relSGHtml += "</tbody></table>";
        document.getElementById('relBySubjectGrade').innerHTML = relSGHtml;
        if(window.taskCompletionChart) window.taskCompletionChart.destroy();
        window.taskCompletionChart = new Chart(document.getElementById('taskCompletionBar'), { type: 'bar', data: { labels: Object.keys(taskCounts), datasets: [{ label: 'Task Completion Count', data: Object.values(taskCounts), backgroundColor: 'rgba(79, 172, 254, 0.8)', borderColor: '#4facfe', borderWidth: 2 }] }, options: { animation: false, responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)' } }, x: { grid: { display: false } } } } });
        let distHtml = `<table><thead><tr><th>District</th><th>Total Evidence</th><th>Blocks</th><th>Schools</th><th>Relevant</th><th>Partially Relevant</th><th>Irrelevant</th><th>% Relevant</th></tr></thead><tbody>`;
        const sortedDistricts = Object.keys(districtStats).sort();
        for (const d of sortedDistricts) { const st = districtStats[d]; const relevantPercent = ((st.Relevant/st.total)*100).toFixed(1); distHtml += `<tr><td><strong>${d}</strong></td><td>${st.total.toLocaleString()}</td><td>${st.blocks.size}</td><td>${st.schools.size}</td><td>${st.Relevant}</td><td>${st["Partially Relevant"]}</td><td>${st.Irrelevant}</td><td><span class="percentage-badge">${relevantPercent}%</span></td></tr>`; }
        distHtml += "</tbody></table>";
        document.getElementById('districtTable').innerHTML = distHtml;
        window.currentDistrictStats = districtStats;
        generateBiharMap(districtStats);
        let blockArr = Object.entries(blockStats).map(([b,st])=>[b, ((st.Relevant/st.total)*100).toFixed(1), st.schools.size, st.total]);
        blockArr.sort((a,b)=>b[1]-a[1]);
        let top15 = blockArr.slice(0,15);
        let bottom15 = blockArr.slice(-15);
        let tbHtml = `<div class="grid grid-2"><div class="top-blocks"><div class="blocks-title">üèÜ Top 15 Blocks (by % Relevant)</div>`;
        top15.forEach((block, index) => { tbHtml += `<div class="block-item"><div class="block-name">#${index + 1} ${block[0]}</div><div class="block-stats"><span>Schools: ${block[2]}</span><span>Evidence: ${block[3]}</span><span class="percentage-badge">${block[1]}%</span></div></div>`; });
        tbHtml += `</div><div class="bottom-blocks"><div class="blocks-title">üìâ Bottom 15 Blocks (by % Relevant)</div>`;
        bottom15.forEach((block, index) => { tbHtml += `<div class="block-item"><div class="block-name">#${bottom15.length - index} ${block[0]}</div><div class="block-stats"><span>Schools: ${block[2]}</span><span>Evidence: ${block[3]}</span><span class="percentage-badge">${block[1]}%</span></div></div>`; });
        tbHtml += `</div></div>`;
        document.getElementById('topBottomBlocks').innerHTML = tbHtml;
    }

    function generateBiharMap(districtStats) {
        const geojsonFile = document.getElementById('geojsonFile').files[0];
        if (geojsonFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try { const geojson = JSON.parse(e.target.result); renderBiharMap(geojson, districtStats); } 
                catch (error) { document.getElementById('biharMap').innerHTML = `<div style="text-align: center; padding: 20px; color: #ff6b6b;">Invalid GeoJSON file format.</div>`; }
            };
            reader.readAsText(geojsonFile);
        } else {
            const geojsonUrl = 'https://raw.githubusercontent.com/Vivek-M-08/maps/main/states/bihar.geojson';
            document.getElementById('biharMap').innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">Loading map...</p>';
            fetch(geojsonUrl, { mode: 'cors', headers: { 'Accept': 'application/json' } })
                .then(response => { if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); return response.json(); })
                .then(geojson => { renderBiharMap(geojson, districtStats); })
                .catch(error => { console.error('Error loading Bihar GeoJSON:', error);
                    document.getElementById('biharMap').innerHTML = `<div style="text-align: center; padding: 20px;"><p style="color: #718096; margin-bottom: 10px;">Unable to load map.</p><p style="color: #718096; font-size: 0.9em; margin-bottom: 10px;">Please upload the bihar.geojson file and process again.</p><button onclick="generateSimplifiedBiharMap()" style="margin-top: 10px; padding: 8px 16px; background: #4facfe; color: white; border: none; border-radius: 5px; cursor: pointer;">Or Load Simplified Map</button></div>`;
                });
        }
    }

    window.generateSimplifiedBiharMap = function() {
        renderSimplifiedBiharMap(window.currentDistrictStats || {});
    }

    function renderSimplifiedBiharMap(districtStats) {
        function getColorForPercentage(percentage) { if (percentage >= 60) return '#42e695'; if (percentage >= 40) return '#feca57'; return '#ff6b6b'; }
        const districts = { "Patna": { x: 250, y: 180, w: 40, h: 35 }, "Gaya": { x: 270, y: 215, w: 45, h: 40 }, "Nalanda": { x: 240, y: 200, w: 30, h: 25 }, "Muzaffarpur": { x: 200, y: 120, w: 50, h: 35 }, "Darbhanga": { x: 250, y: 110, w: 45, h: 35 }, "Bhagalpur": { x: 360, y: 160, w: 40, h: 35 }, "Purnia": { x: 390, y: 80, w: 35, h: 35 }, "Saharsa": { x: 340, y: 110, w: 35, h: 35 }, "Madhubani": { x: 290, y: 100, w: 35, h: 30 }, "Sitamarhi": { x: 230, y: 90, w: 35, h: 30 }, "Sheohar": { x: 200, y: 100, w: 30, h: 30 }, "East Champaran": { x: 150, y: 80, w: 45, h: 45 }, "West Champaran": { x: 100, y: 90, w: 50, h: 45 }, "Gopalganj": { x: 160, y: 130, w: 35, h: 25 }, "Siwan": { x: 120, y: 135, w: 40, h: 30 }, "Saran": { x: 170, y: 155, w: 35, h: 30 }, "Vaishali": { x: 220, y: 175, w: 35, h: 30 }, "Samastipur": { x: 260, y: 145, w: 40, h: 30 }, "Begusarai": { x: 310, y: 165, w: 35, h: 25 }, "Khagaria": { x: 350, y: 145, w: 30, h: 25 }, "Munger": { x: 360, y: 175, w: 30, h: 25 }, "Jamui": { x: 320, y: 215, w: 30, h: 30 }, "Banka": { x: 370, y: 195, w: 30, h: 25 }, "Lakhisarai": { x: 320, y: 195, w: 30, h: 25 }, "Sheikhpura": { x: 290, y: 195, w: 30, h: 25 }, "Nawada": { x: 300, y: 225, w: 30, h: 30 }, "Aurangabad": { x: 270, y: 245, w: 30, h: 30 }, "Rohtas": { x: 210, y: 235, w: 35, h: 30 }, "Kaimur": { x: 180, y: 255, w: 35, h: 30 }, "Buxar": { x: 150, y: 225, w: 35, h: 30 }, "Bhojpur": { x: 190, y: 215, w: 30, h: 25 }, "Araria": { x: 420, y: 75, w: 30, h: 25 }, "Kishanganj": { x: 450, y: 60, w: 30, h: 25 }, "Katihar": { x: 400, y: 115, w: 30, h: 25 }, "Madhepura": { x: 370, y: 105, w: 30, h: 25 }, "Supaul": { x: 340, y: 95, w: 30, h: 25 }, "Arwal": { x: 260, y: 255, w: 25, h: 25 }, "Jehanabad": { x: 250, y: 225, w: 25, h: 25 } };
        let svgContent = '<svg viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">';
        for (let districtName in districts) { const d = districts[districtName]; let color = '#e0e0e0'; let tooltipText = `${districtName}: No data`; const matchedDistrict = Object.keys(districtStats).find(key => key.toLowerCase().trim() === districtName.toLowerCase().trim()); if (matchedDistrict) { const stats = districtStats[matchedDistrict]; const percentage = ((stats.Relevant / stats.total) * 100).toFixed(1); color = getColorForPercentage(parseFloat(percentage)); tooltipText = `${districtName}\n${percentage}% Relevant\nTotal: ${stats.total}\nRelevant: ${stats.Relevant}\nPartially: ${stats["Partially Relevant"]}\nIrrelevant: ${stats.Irrelevant}`; } svgContent += `<rect class="district-path" x="${d.x}" y="${d.y}" width="${d.w}" height="${d.h}" fill="${color}" data-district="${districtName}" data-tooltip="${tooltipText}"></rect>`; svgContent += `<text x="${d.x + d.w/2}" y="${d.y + d.h/2}" fill="white" font-size="8" text-anchor="middle" dominant-baseline="middle" style="pointer-events: none; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${districtName.split(' ')[0]}</text>`; }
        svgContent += '</svg>';
        document.getElementById('biharMap').innerHTML = svgContent; addTooltipHandlers();
    }

    function renderBiharMap(geojson, districtStats) {
        function getColorForPercentage(percentage) { if (percentage >= 60) return '#42e695'; if (percentage >= 40) return '#feca57'; return '#ff6b6b'; }
        function collectAllCoords(feature) { const coords = []; const geom = feature.geometry; if (!geom) return coords; if (geom.type === 'Polygon') { geom.coordinates.forEach(ring => ring.forEach(pt => coords.push(pt))); } else if (geom.type === 'MultiPolygon') { geom.coordinates.forEach(polygon => polygon.forEach(ring => ring.forEach(pt => coords.push(pt)))); } return coords; }
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        geojson.features.forEach(feature => { collectAllCoords(feature).forEach(pt => { const [x, y] = pt; if (x < minX) minX = x; if (y < minY) minY = y; if (x > maxX) maxX = x; if (y > maxY) maxY = y; }); });
        if (!(isFinite(minX) && isFinite(minY) && isFinite(maxX) && isFinite(maxY))) { document.getElementById('biharMap').innerHTML = '<div style="padding:20px; color:#ff6b6b;">Invalid GeoJSON geometry.</div>'; return; }
        const width = 800, height = 600, padding = 20; const scale = Math.min((width - 2 * padding) / (maxX - minX), (height - 2 * padding) / (maxY - minY));
        function projectPoint(coord) { const [x, y] = coord; return [(x - minX) * scale + padding, height - ((y - minY) * scale + padding)]; }
        function buildPathData(feature) { const geom = feature.geometry; if (!geom) return ''; const buildFromRings = (rings) => rings.map(ring => ring.map((coord, i) => { const [px, py] = projectPoint(coord); return (i === 0 ? `M ${px} ${py}` : `L ${px} ${py}`); }).join(' ') + ' Z' ).join(' '); if (geom.type === 'Polygon') return buildFromRings(geom.coordinates); if (geom.type === 'MultiPolygon') return geom.coordinates.map(polygon => buildFromRings(polygon)).join(' '); return ''; }
        let svgContent = `<svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;
        geojson.features.forEach(feature => { const districtName = feature.properties?.district_name || feature.properties?.district || feature.properties?.name || 'Unknown'; const pathData = buildPathData(feature); if (!pathData) return; let color = '#e0e0e0'; let tooltipText = `${districtName}: No data`; const matchedDistrict = Object.keys(districtStats || {}).find(key => key.toLowerCase().trim() === districtName.toLowerCase().trim()); if (matchedDistrict) { const stats = districtStats[matchedDistrict]; const percentage = ((stats.Relevant / stats.total)*100).toFixed(1); color = getColorForPercentage(parseFloat(percentage)); tooltipText = `${districtName}\n${percentage}% Relevant\nTotal: ${stats.total}\nRelevant: ${stats.Relevant}\nPartially: ${stats["Partially Relevant"]}\nIrrelevant: ${stats.Irrelevant}`; } svgContent += `<path class="district-path" d="${pathData}" fill="${color}" data-district="${districtName}" data-tooltip="${tooltipText}"></path>`; });
        svgContent += '</svg>';
        document.getElementById('biharMap').innerHTML = svgContent; addTooltipHandlers();
    }

    function addTooltipHandlers() {
        let tooltip = document.querySelector('.district-tooltip'); if (!tooltip) { tooltip = document.createElement('div'); tooltip.className = 'district-tooltip'; document.body.appendChild(tooltip); }
        const paths = document.querySelectorAll('#biharMap .district-path');
        paths.forEach(path => {
            path.addEventListener('mouseenter', (e) => { tooltip.innerHTML = e.target.dataset.tooltip.replace(/\n/g, '<br>'); tooltip.style.opacity = '1'; });
            path.addEventListener('mousemove', (e) => { tooltip.style.left = (e.pageX + 10) + 'px'; tooltip.style.top = (e.pageY + 10) + 'px'; });
            path.addEventListener('mouseleave', () => { tooltip.style.opacity = '0'; });
        });
    }

   
    // --- 2. FINAL, STABLE PDF DOWNLOAD LOGIC ---

    // Utility to convert px to mm
    function pxToMM(px) {
        return px * 0.264583;
    }

    /**
     * This is the function your "Download PDF" button must call.
     * <button class="btn-download" onclick="downloadPDF()">üìÑ Download PDF</button>
     */
    function downloadPDF() {
        const element = document.getElementById('report');
        if (element.classList.contains('hidden')) {
            alert('Please process the CSV data first before downloading PDF.');
            return;
        }

        // 1. Show loading spinner
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'pdf-loading-spinner'; // Give it an ID to remove it
        loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 18px;';
        loadingDiv.innerHTML = '<div><div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #4facfe; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>Generating PDF...</div>';
        document.body.appendChild(loadingDiv);

        // 2. Prepare for PDF: Hide SVG, show placeholder
        const mapContainer = document.getElementById('biharMap');
        const originalMapHTML = mapContainer.innerHTML; // Save the live map
        
        // Replace map with a simple placeholder div
        mapContainer.innerHTML = `
            <div style="width: 100%; height: 500px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 1px dashed #ccc; border-radius: 8px;">
                <p style="color: #666; font-size: 16px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    Map is available in the interactive HTML report.
                </p>
            </div>
        `;

        // 3. Wait for browser to render the placeholder
        // THIS FIXES THE TRIMMING
        setTimeout(() => {
            
            // 4. Get Correct Height
            const contentWidthPx = element.offsetWidth;
            const contentHeightPx = element.scrollHeight; // This is now the correct, full height
            
            // --- THIS IS THE FIX FOR PAGE SPLITTING ---
            // We create a format that is the EXACT size of the content
            // And then add a margin.
            const contentWidthMM = pxToMM(contentWidthPx);
            const contentHeightMM = pxToMM(contentHeightPx);
            const customFormat = [contentWidthMM, contentHeightMM];

            // 5. Configure PDF options
            const opt = {
                // Add a 10mm margin, which adds to the page size
                margin: 10, 
                filename: 'MIP_Evidence_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    scrollX: 0,
                    scrollY: 0,
                    width: contentWidthPx,  // Capture at exact width
                    height: contentHeightPx, // Capture at exact height
                },
                jsPDF: {
                    unit: 'mm',
                    format: customFormat, // Use the exact content size as the format
                    orientation: 'portrait',
                    compress: true
                },
            };

            // 6. Generate PDF
            html2pdf().set(opt).from(element).save().finally(() => {
                // 7. CLEANUP: This *always* runs
                mapContainer.innerHTML = originalMapHTML; // Put the live map back
                addTooltipHandlers(); // Re-attach map tooltips
                if (loadingDiv) loadingDiv.remove(); // Remove spinner
            });

        }, 100); // 100ms delay for rendering
    }
    
    // --- 3. EVENT LISTENERS ---
    document.getElementById('csvFile').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name || 'Choose CSV File';
        const label = document.querySelector('label[for="csvFile"]');
        label.textContent = fileName.length > 20 ? 'üìÅ ' + fileName.substring(0, 20) + '...' : 'üìÅ ' + fileName;
    });

    document.getElementById('geojsonFile').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name || 'Choose GeoJSON File (Optional)';
        const label = document.querySelector('label[for="geojsonFile"]');
        label.textContent = fileName.length > 25 ? 'üó∫Ô∏è ' + fileName.substring(0, 25) + '...' : 'üó∫Ô∏è ' + fileName;
    });
</script>

</body>
</html>